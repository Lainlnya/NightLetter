pipeline {
    agent any

    environment {
        service = "nightletter-server"
    }
    
    tools {
        gradle 'Gradle'
    }
    stages {
        stage('Checkout') {
            steps {
                // 소스 코드 체크아웃
                checkout scm
            }
        }
        stage('Jar Build') {
            steps {
                // Gradle을 사용하여 ${service} 프로젝트 빌드
                sh 'cd back-end && chmod +x gradlew && ./gradlew clean build -x test'
            }
        }
        stage('Docker Image Build') {
            steps {
                // 이미지 생성 중 . . .
                echo 'No ${service} running . . . About to Build a image . . .'

                sh 'cp /var/jenkins_home/.env .'
                sh 'docker build -t ${service} -f ./back-end/Dockerfile .'
                sh 'docker-compose up -d'
                sh 'docker restart nginx | true'
            }
        }
    }
}
